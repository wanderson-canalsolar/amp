jQuery(function(B){"use strict";var d=B(document).find(".ywarc_new_rules"),J=B(document).find(".ywarc_rules_group"),a=B("#yith_ywarc_add_rule_button"),r=B(".ywarc_new_rule_title"),t=B(".ywarc_creating_rule");function i(e,h){var v=B(e),g=v.data("rule_id"),a=v.find(".rule_head"),k=v.find(".rule_options"),b=a.find("label.rule_title").text();h&&(d.append(v),k.show(),N()),a.on("click",function(e){k.slideToggle()}),v.trigger("init_tooltips");var j=k.find("div.rule_type_block"),D=k.find("div.role_selector_block");D.hide();var C=k.find("div.replace_role_block");C.hide();var z=k.find("div.rule_radio_group");z.hide();var x=k.find("div.specific_product_block");x.hide();var S=k.find("div.specific_range_block");S.hide();var F=k.find("div.specific_taxonomy_block");F.hide();var I=F.find("div.category_search_block");I.hide();var M=F.find("div.tag_search_block");M.hide();var l=k.find("div.date_range_block");l.hide();var r=k.find("div.duration_block");r.hide();var L=k.find("div.role_filter_selector_block");L.hide();var t=k.find("div.submit_block");t.hide();function i(e){"role_selector"!=e&&"all"!=e||(D.removeClass("empty_field"),C.removeClass("empty_field")),"product_selector"!=e&&"all"!=e||x.removeClass("empty_field"),"price_range"!=e&&"all"!=e||(S.removeClass("empty_field"),S.removeClass("ywarc_from_gt_to")),"category"!=e&&"all"!=e||(I.removeClass("empty_field"),F.removeClass("empty_field")),"tag"!=e&&"all"!=e||(M.removeClass("empty_field"),F.removeClass("empty_field"))}var _,T=S.find('input[name="price_range_from"]'),q=S.find('input[name="price_range_to"]'),O=l.find(".sale_price_dates_from"),R=l.find(".sale_price_dates_to"),A=r.find(".ywarc_duration");T.on("change",function(){i("price_range")}),q.on("change",function(){i("price_range")}),k.find(".sale_price_dates_fields").each(function(){var t=B(this).find("input").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0,onSelect:function(e){var a=B(this).is(".sale_price_dates_from")?"minDate":"maxDate",l=B(this).data("datepicker"),r=B.datepicker.parseDate(l.settings.dateFormat||B.datepicker._defaults.dateFormat,e,l.settings);t.not(this).datepicker("option",a,r)}})}),k.find("input.ywarc_rule_type_radio_button").change(function(){var e=k.find("input.ywarc_rule_type_radio_button:checked");"add"==e.val()?(C.hide(),D.slideDown(),z.show()):"replace"==e.val()&&(C.slideDown(),D.hide(),z.show())}).change(),k.find("input.ywarc_rule_radio_button").change(function(){i("all");var e=k.find("input.ywarc_rule_radio_button:checked");"product"==e.val()?(S.hide(),F.hide(),x.slideDown(),l.slideDown(),r.slideDown(),L.slideDown(),t.slideDown()):"range"==e.val()||"overall"==e.val()?(x.hide(),F.hide(),S.slideDown(),l.slideDown(),r.slideDown(),L.slideDown(),t.slideDown()):"taxonomy"==e.val()&&(x.hide(),S.hide(),F.slideDown(),l.slideDown(),r.slideDown(),L.slideDown(),t.slideDown())}).change(),F.find("input.ywarc_tax_radio_button").change(function(){i("all");var e=F.find("input.ywarc_tax_radio_button:checked");"category"==e.val()?(M.hide(),I.show()):"tag"==e.val()&&(I.hide(),M.show())}).change(),_=localize_js_ywarc_admin.before_2_7?{maximumSelectionSize:1}:{maximumSelectionLength:1},k.find(".ywarc_role_selector, .ywarc_replace_role_before, .ywarc_replace_role_after").select2(_).on("change",function(){i("role_selector")}),L.find(".role_filter_selector").select2(),B(document.body).trigger("wc-enhanced-select-init"),B(":input.wc-product-search").on("change",function(){i("product_selector")});function n(e){var l=[];return e&&B.each(e,function(e,a){l.push({id:e,text:a})}),{results:l}}function c(e,a){var l=B.parseJSON(e.attr("data-selected")),r=[];return B(e.val().split(",")).each(function(e,a){r.push({id:a,text:l[a]})}),a(r)}function o(e){return'<div class="selected-option" data-id="'+e.id+'">'+e.text+"</div>"}B(":input.ywarc-category-search").filter(":not(.enhanced)").each(function(){var e={url:localize_js_ywarc_admin.ajax_url,dataType:"json",quietMillis:250,data:function(e){return{term:e,action:"ywarc_category_search",security:localize_js_ywarc_admin.search_categories_nonce}},cache:!0};localize_js_ywarc_admin.before_2_7?e.results=n:e.processResults=n;var a={initSelection:localize_js_ywarc_admin.before_2_7?c:null,formatSelection:localize_js_ywarc_admin.before_2_7?o:null,multiple:B(this).data("multiple"),allowClear:!!B(this).data("allow_clear"),placeholder:B(this).data("placeholder"),minimumInputLength:B(this).data("minimum_input_length")?B(this).data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:e};B(this).select2(a).addClass("enhanced").on("change",function(){i("category")})}),B(":input.ywarc-tag-search").filter(":not(.enhanced)").each(function(){var e={url:localize_js_ywarc_admin.ajax_url,dataType:"json",quietMillis:250,data:function(e){return{term:e,action:"ywarc_tag_search",security:localize_js_ywarc_admin.search_tags_nonce}},cache:!0};localize_js_ywarc_admin.before_2_7?e.results=n:e.processResults=n;var a={initSelection:localize_js_ywarc_admin.before_2_7?c:null,formatSelection:localize_js_ywarc_admin.before_2_7?o:null,multiple:B(this).data("multiple"),allowClear:!!B(this).data("allow_clear"),placeholder:B(this).data("placeholder"),minimumInputLength:B(this).data("minimum_input_length")?B(this).data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:e};B(this).select2(a).addClass("enhanced").on("change",function(){i("tag")})}),t.find("input").on("click",function(e){e.preventDefault(),v.block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var a,l=j.find("input.ywarc_rule_type_radio_button:checked").val(),r=D.find("select.ywarc_role_selector").val(),t=C.find("select.ywarc_replace_role_before").val(),i=C.find("select.ywarc_replace_role_after").val(),_=k.find("input.ywarc_rule_radio_button:checked").val(),n=x.find(':input[id^="ywarc_product_selector"]').val(),c=T.val(),o=q.val(),d=F.find("input.ywarc_tax_radio_button:checked").val(),s=I.find(':input[id^="ywarc_category_selector"]').val(),u=M.find(':input[id^="ywarc_tag_selector"]').val(),f=O.val(),p=R.val(),y=A.val(),m=L.find("select.role_filter_selector").val(),w=!0;"add"==l?r||(w=!1,D.addClass("empty_field")):"replace"==l?t&&i||(w=!1,C.addClass("empty_field")):(w=!1,j.addClass("empty_field")),"product"==_?n||(w=!1,x.addClass("empty_field")):"range"==_||"overall"==_?(c||o||(w=!1,S.addClass("empty_field")),o&&parseInt(c)>=parseInt(o)&&(w=!1,S.addClass("ywarc_from_gt_to"))):"taxonomy"==_?"category"==d?s||(w=!1,I.addClass("empty_field")):"tag"==d?u||(w=!1,M.addClass("empty_field")):(w=!1,F.addClass("empty_field")):(w=!1,z.addClass("empty_field")),w?(y=parseInt(y,10),a={action:"ywarc_save_rule",title:b,rule_id:g,rule_type:l,role_selected:r||"",replace_roles:t&&i?[t,i]:"",radio_group:_,product_selected:"product"===_?n:"",price_range_from:"range"===_||"overall"===_?c:"",price_range_to:"range"===_||"overall"===_?o:"",tax_radio_group:"taxonomy"===_?d:"",categories_selected:"taxonomy"===_&&"category"===d?s:"",tags_selected:"taxonomy"===_&&"tag"===d?u:"",date_from:f,date_to:p,duration:y=0<y?y:"",role_filter:m},B.post(localize_js_ywarc_admin.ajax_url,a,function(e){v.unblock(),h&&(J.append(v),k.hide(),h=!1),0<J.find(".rule_block").length&&B("#my_rules_header").removeClass("no_rules"),N()})):v.unblock(),N()}),t.find("a.delete_rule").on("click",function(e){var a;e.preventDefault(),1==confirm(localize_js_ywarc_admin.delete_rule_msg)&&(h?v.remove():(v.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a={action:"ywarc_delete_rule",rule_id:g},B.post(localize_js_ywarc_admin.ajax_url,a,function(e){v.unblock(),v.remove(),0==J.find(".rule_block").length&&B("#my_rules_header").addClass("no_rules")})),0==J.find(".rule_block").length&&B("#my_rules_header").addClass("no_rules")),N()})}function N(){0<d.find(".rule_block").length?B("#ywarc_new_rules_row").removeClass("no_rules"):B("#ywarc_new_rules_row").addClass("no_rules")}r.focus(),r.keydown(function(e){13==e.which&&(a.focus(),a.trigger("click"))}),a.on("click",function(e){e.preventDefault();var a=r.val().trim(),l=[];d.find(".rule_title").each(function(){l.push(B(this).text())}),"-1"!=B.inArray(a,l)?(alert(localize_js_ywarc_admin.duplicated_name_msg),r.val(""),r.focus()):""==a?(alert(localize_js_ywarc_admin.empty_name_msg),r.focus()):(t.block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),B.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_add_rule",title:a},function(e){t.unblock(),r.val(""),"duplicated_name_error"===e?(alert(localize_js_ywarc_admin.duplicated_name_msg),r.focus()):i(e,!0)}))}),B(".rule_block").each(function(e,a){i(a,!1)}),B("#show_all_rules").on("click",function(e){e.preventDefault(),J.find(".rule_options").slideDown()}),B("#hide_all_rules").on("click",function(e){e.preventDefault(),J.find(".rule_options").slideUp()}),B("#delete_all_rules").on("click",function(e){e.preventDefault(),1==confirm(localize_js_ywarc_admin.delete_all_rules_msg)&&(t.block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),B.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_delete_all_rules"},function(e){t.unblock(),J.find(".rule_block").remove(),B("#my_rules_header").addClass("no_rules")})),N()}),B("#ywarc_force_apply_rules_set_dates_button").on("click",function(e){e.preventDefault(),B(".ywarc_force_apply_rules_dates").toggle(400)});var c=B("#ywarc_force_apply_rules_from_date").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",maxDate:0}),o=B("#ywarc_force_apply_rules_to_date").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",maxDate:0});c.datepicker("option","onSelect",function(e){o.datepicker("option","minDate",e)}),o.datepicker("option","onSelect",function(e){c.datepicker("option","maxDate",e)}),B("#ywarc_force_apply_rules").on("click",function(e){e.preventDefault();var a,l,r,t,i="none"===B(".ywarc_force_apply_rules_dates").css("display"),_=localize_js_ywarc_admin.force_apply_rules_warning+" ",n={action:"ywarc_force_apply_rules",security:localize_js_ywarc_admin.force_apply_rules_nonce,ywarc_find_all_orders:i?"1":"0"};i?_+=localize_js_ywarc_admin.force_apply_all_rules:(a=B("[name='ywarc_force_apply_rules_set_date_type']:checked").val(),l=c.val()?c.val():"",r=o.val()?o.val():"",n.ywarc_date_type=a,n.ywarc_from=l,n.ywarc_to=r,l||r?l&&r?_+=localize_js_ywarc_admin.force_apply_date_range_rules:l&&!r?_+=localize_js_ywarc_admin.force_apply_date_from_rules:!l&&r&&(_+=localize_js_ywarc_admin.force_apply_date_to_rules):_+=localize_js_ywarc_admin.force_apply_all_rules,_=(_=_.replace("{date_from}",l)).replace("{date_to}",r)),l&&r&&r<l?alert(localize_js_ywarc_admin.force_apply_rules_dates_warning):window.confirm(_)&&((t=B("span.ywarc_creating_rule.ywarc_force_apply_rules_row")).block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),B.post(localize_js_ywarc_admin.ajax_url,n,function(e){e.success||"from_date_gt_to_date_error"!==e.data||alert(localize_js_ywarc_admin.force_apply_rules_dates_warning),t.unblock()}))})});